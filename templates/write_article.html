{% extends 'base.html' %}
{% block content %}
<!-- 1. 引入 Editor.md 和 Cropper.js 的资源 -->
<link rel="stylesheet" href="{{ url_for('static', filename='editormd/css/editormd.min.css') }}"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<style>
    /* 现代感写作页面样式 */
    .writing-container {
        padding: 10px 0;
    }

    /* 标题样式 */
    .title-input {
        width: 100%;
        border: none;
        border-bottom: 2px solid #eee;
        font-size: 32px;
        font-weight: 700;
        padding: 10px 0;
        margin-bottom: 20px;
        outline: none;
        color: #333;
        transition: border-color 0.3s;
    }

    .title-input:focus {
        border-bottom-color: #4285f4;
    }

    /* 封面上传区域布局 */
    .cover-upload-container {
        display: flex;
        gap: 30px;
        margin-bottom: 25px;
    }

    .cover-box {
        width: 240px;
        height: 135px; /* 16:9 比例预览 */
        border: 2px dashed #ddd;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        background: #fcfcfc;
        position: relative;
        transition: border-color 0.3s;
    }

    .cover-box:hover {
        border-color: #4285f4;
    }

    .cover-preview-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        display: none;
    }

    .meta-inputs {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .input-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .input-item label {
        font-size: 13px;
        color: #888;
        font-weight: 600;
        text-transform: uppercase;
    }

    .modern-input {
        border: 1px solid #e0e0e0;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 14px;
        background: #fcfcfc;
        outline: none;
        transition: all 0.3s;
    }

    .modern-input:focus {
        border-color: #4285f4;
        background: #fff;
        box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }

    #article-editor {
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    /* 裁剪弹窗专用样式 */
    #cropper-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        padding: 25px;
        border-radius: 12px;
        width: 800px;
        max-width: 95%;
    }

    .cropper-wrapper {
        width: 100%;
        height: 450px;
        background: #333;
        overflow: hidden;
        border-radius: 4px;
    }
</style>

<div class="writing-container">
    <h2 style="font-weight: 400; color: #666; margin-bottom: 10px;">撰写新文章</h2>

    <form id="article-form" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="post_status" id="post-status" value="published">

        <!-- 标题区域 -->
        <div class="title-wrapper">
            <input type="text" name="title" id="article-title" class="title-input" placeholder="在此输入文章标题..."
                   required>
        </div>

        <!-- 封面、分类与标签 -->
        <div class="cover-upload-container">
            <div class="input-item">
                <label>文章封面 (16:9 裁剪)</label>
                <div class="cover-box" onclick="document.getElementById('cover-input').click()">
                    <img id="cover-preview" src="" class="cover-preview-img">
                    <div id="upload-placeholder" style="text-align: center; color: #aaa;">
                        <span style="font-size: 24px;">+</span><br>
                        <span style="font-size: 12px;">上传封面图</span>
                    </div>
                </div>
                <!-- 隐藏的原始文件输入框 -->
                <input type="file" name="cover_file" id="cover-input" hidden accept="image/*">
            </div>

            <div class="meta-inputs">
                <div class="input-item">
                    <label>文章分类</label>
                    <input type="text" name="category" list="cl" class="modern-input" placeholder="选择或输入新分类">
                    <datalist id="cl">
                        {% for c in categories %}
                        <option value="{{c.name}}">{% endfor %}
                    </datalist>
                </div>
                <div class="input-item">
                    <label>文章标签</label>
                    <input type="text" name="tags" class="modern-input" placeholder="多个标签用英文逗号隔开">
                </div>
            </div>
        </div>

        <!-- 摘要区域 -->
        <div class="form-group" style="margin-bottom: 20px;">
            <label style="font-size: 13px; color: #888; font-weight: 600;">文章摘要
                (手动填写，将展示在首页卡片上)</label>
            <textarea name="summary" class="modern-input" style="height: 70px; resize: none; margin-top: 8px;"
                      placeholder="如果不填写，系统将自动截取正文前100字..."></textarea>
        </div>

        <!-- 编辑器区域 -->
        <div id="article-editor">
            <textarea name="content" style="display:none;"></textarea>
        </div>

        <!-- 底部操作按钮 -->
        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 15px;">
            <button type="button" class="btn" style="background:#f4f4f4; color:#666;" onclick="checkDraft()">
                保存草稿并返回
            </button>
            <button type="submit" class="btn" style="background:#28a745; padding: 10px 40px;"
                    onclick="document.getElementById('post-status').value='published'">
                发布文章
            </button>
        </div>
    </form>
</div>

<!-- 裁剪弹窗 HTML -->
<div id="cropper-modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">裁剪封面图片</h3>
        <div class="cropper-wrapper">
            <img id="cropper-image-temp">
        </div>
        <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn" style="background:#999;" onclick="closeCropper()">取消</button>
            <button class="btn" id="confirm-crop-btn">确定裁剪</button>
        </div>
    </div>
</div>

<!-- 脚本部分 -->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="{{ url_for('static', filename='editormd/editormd.min.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    var editor;
    var cropper;
    const coverInput = document.getElementById('cover-input');
    const cropperModal = document.getElementById('cropper-modal');
    const cropperImage = document.getElementById('cropper-image-temp');

    $(function () {
        editor = editormd("article-editor", {
            width: "100%", height: 600, path: "{{ url_for('static', filename='editormd/lib/') }}",
            saveHTMLToTextarea: true, emoji: true, imageUpload: true,
            imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
            imageUploadURL: "{{ url_for('upload_article_img') }}"
        });
    });

    // 1. 选择图片后弹出裁剪框
    coverInput.addEventListener('change', function (e) {
        const files = e.target.files;
        if (files && files.length > 0) {
            const reader = new FileReader();
            reader.onload = function (event) {
                cropperImage.src = event.target.result;
                cropperModal.style.display = 'flex';

                if (cropper) cropper.destroy();
                cropper = new Cropper(cropperImage, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    background: false
                });
            };
            reader.readAsDataURL(files[0]);
        }
    });

    // 2. 确认裁剪并显示预览
    document.getElementById('confirm-crop-btn').addEventListener('click', function () {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas({width: 800, height: 450});

        canvas.toBlob(function (blob) {
            // 更新预览图
            const previewUrl = URL.createObjectURL(blob);
            document.getElementById('cover-preview').src = previewUrl;
            $('#cover-preview').fadeIn();
            $('#upload-placeholder').hide();

            // 【核心】将裁剪后的数据塞回 input
            let file = new File([blob], "cover.jpg", {type: "image/jpeg"});
            let container = new DataTransfer();
            container.items.add(file);
            coverInput.files = container.files;

            closeCropper();
        }, 'image/jpeg');
    });

    function closeCropper() {
        cropperModal.style.display = 'none';
        if (!document.getElementById('cover-preview').src) {
            coverInput.value = '';
        }
    }

    function checkDraft() {
        var content = editor.getMarkdown();
        var title = document.getElementById('article-title').value;
        if (content.trim() !== "" || title.trim() !== "") {
            if (confirm("是否保存当前内容到草稿并返回？")) {
                document.getElementById('post-status').value = 'draft';
                document.getElementById('article-form').submit();
            } else {
                window.location.href = "{{ url_for('dashboard') }}";
            }
        } else {
            window.location.href = "{{ url_for('dashboard') }}";
        }
    }
</script>
{% endblock %}