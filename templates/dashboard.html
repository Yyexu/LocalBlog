{% extends 'base.html' %}
{% block content %}

<!-- 顶部标题行 -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin:0;">个人管理面板</h2>
    <a href="{{ url_for('create_article') }}" class="btn">+ 写新文章</a>
</div>

<!-- 1. 个人资料区 (对应你的红框草图) -->
<div class="card">
    <!-- 隐藏的头像选择 input -->
    <input type="file" id="avatar-input" style="display:none;" accept="image/*">

    <!-- 资料更新表单 -->
    <form action="{{ url_for('update_profile') }}" method="POST">
        <div style="display: flex; gap: 30px; align-items: flex-start;">

            <!-- 左侧：点击头像触发 -->
            <div style="text-align: center;">
                <div style="position: relative; cursor: pointer;"
                     onclick="document.getElementById('avatar-input').click()" title="点击修改头像">
                    <img id="current-avatar-img" src="{{ current_user.avatar_url }}"
                         style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid #eee; object-fit: cover;">
                    <div style="position: absolute; bottom: 0; background: rgba(0,0,0,0.4); color: white; width: 100%; font-size: 10px; border-bottom-left-radius: 50px; border-bottom-right-radius: 50px; padding: 2px 0;">
                        修改
                    </div>
                </div>
                <div style="font-size: 12px; color: #999; margin-top: 5px;">{{ current_user.username }}</div>
            </div>

            <!-- 右侧：昵称、性别等字段 (保持你原来的代码) -->
            <div style="flex: 1;">
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div style="flex: 2;">
                        <label style="font-size: 12px; color: #888;">昵称</label>
                        <input type="text" name="nickname" class="modern-input"
                               value="{{ current_user.nickname or '' }}">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 12px; color: #888;">性别</label>
                        <select name="gender" class="modern-input" style="height: 41px;">
                            <option value="保密" {% if current_user.gender==
                            '保密' %}selected{% endif %}>保密</option>
                            <option value="男" {% if current_user.gender==
                            '男' %}selected{% endif %}>男</option>
                            <option value="女" {% if current_user.gender==
                            '女' %}selected{% endif %}>女</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 12px; color: #888;">个人代码仓库链接</label>
                    <input type="text" name="repo_link" class="modern-input" value="{{ current_user.repo_link or '' }}">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 12px; color: #888;">个人简介</label>
                    <textarea name="bio" class="modern-input" style="height: 80px; resize: none;">{{ current_user.bio or '' }}</textarea>
                </div>
                <div style="text-align: right;">
                    <button type="submit" class="btn" style="padding: 8px 25px; font-size: 12px;">更新资料</button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- 裁剪弹窗 HTML 结构 (初始隐藏) -->
<div id="cropper-modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; padding:25px; border-radius:12px; max-width:500px; width:90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
        <h3 style="margin: 0 0 15px 0;">裁剪头像</h3>
        <div style="width:100%; height:300px; background:#eee; border-radius:8px; overflow:hidden;">
            <img id="cropper-image" style="max-width:100%;">
        </div>
        <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn" style="background:#ccc; color:#333;" onclick="closeCropper()">取消</button>
            <button class="btn" id="save-crop-btn">确定上传</button>
        </div>
    </div>
</div>

<!-- 裁剪逻辑 JavaScript -->
<script>
    let cropper;
    const avatarInput = document.getElementById('avatar-input');
    const modal = document.getElementById('cropper-modal');
    const image = document.getElementById('cropper-image');

    // 1. 用户选择图片后，弹出裁剪框
    avatarInput.addEventListener('change', function (e) {
        const files = e.target.files;
        if (files && files.length > 0) {
            const reader = new FileReader();
            reader.onload = function (event) {
                image.src = event.target.result;
                modal.style.display = 'flex'; // 显示弹窗

                // 初始化 Cropper
                if (cropper) cropper.destroy();
                cropper = new Cropper(image, {
                    aspectRatio: 1, // 强制 1:1 正方形
                    viewMode: 1,
                    autoCropArea: 1
                });
            };
            reader.readAsDataURL(files[0]);
        }
    });

    // 2. 关闭弹窗
    function closeCropper() {
        modal.style.display = 'none';
        avatarInput.value = ''; // 清空选择
    }

    // 3. 确定裁剪并使用 AJAX 上传
    document.getElementById('save-crop-btn').addEventListener('click', function () {
        if (!cropper) return;

        // 获取裁剪后的 Canvas
        const canvas = cropper.getCroppedCanvas({width: 300, height: 300});

        canvas.toBlob(function (blob) {
            const formData = new FormData();
            formData.append('avatar_file', blob, 'avatar.jpg');

            // 按钮变灰，防止重复点击
            document.getElementById('save-crop-btn').innerText = '上传中...';
            document.getElementById('save-crop-btn').disabled = true;

            // 使用 fetch 提交给后端
            fetch("{{ url_for('upload_avatar') }}", {
                method: 'POST',
                body: formData
            }).then(res => {
                if (res.ok) {
                    // 上传成功，直接刷新页面看效果
                    window.location.reload();
                } else {
                    alert('上传失败，请重试');
                }
            });
        }, 'image/jpeg');
    });
</script>

<!-- 2. 统计卡片区 -->
<div style="display: flex; gap: 20px; margin-bottom: 20px;">
    <div class="card" style="flex:1; margin:0; text-align:center; padding: 20px;">
        <h3 style="margin:0; font-size:14px; color:#888;">文章总数</h3>
        <div style="font-size:28px; font-weight:bold; color:#34a853;">{{ article_count }}</div>
    </div>
    <div class="card" style="flex:1; margin:0; text-align:center; padding: 20px;">
        <h3 style="margin:0; font-size:14px; color:#888;">分类数量</h3>
        <div style="font-size:28px; font-weight:bold; color:#fbbc05;">{{ category_count }}</div>
    </div>
    <div class="card" style="flex:1; margin:0; text-align:center; padding: 20px;">
        <h3 style="margin:0; font-size:14px; color:#888;">标签数量</h3>
        <div style="font-size:28px; font-weight:bold; color:#4285f4;">{{ tag_count }}</div>
    </div>
</div>

<!-- 3. 文章列表区 -->
<div class="card" style="padding: 10px 20px;">
    <h3 style="font-size: 16px; margin-bottom: 15px; color: #444;">我的文章列表</h3>
    <table style="width:100%; border-collapse: collapse;">
        <thead>
        <tr style="text-align:left; border-bottom: 2px solid #eee; color: #666; font-size: 14px;">
            <th style="padding:12px 5px; width: 30%;">标题</th>
            <th style="padding:12px 5px; width: 15%;">分类</th>
            <th style="padding:12px 5px; width: 20%;">标签</th> <!-- 补回 -->
            <th style="padding:12px 5px; width: 15%;">最后修改</th> <!-- 补回 -->
            <th style="padding:12px 5px; width: 20%;">操作</th>
        </tr>
        </thead>
        <tbody>
        {% for p in articles %}
        <tr style="border-bottom: 1px solid #f5f5f5; transition: 0.2s;" onmouseover="this.style.background='#fafafa'"
            onmouseout="this.style.background='transparent'">
            <td style="padding:15px 5px;">
                {% if p.is_draft %}
                <span style="color:#fbbc05; font-weight: bold; font-size: 12px;">[草稿]</span>
                {% endif %}
                <span style="color: #333; font-weight: 500;">{{ p.title }}</span>
            </td>
            <td>
                    <span style="background:#e8f0fe; color: #1967d2; padding:2px 8px; border-radius:4px; font-size:12px;">
                        {{ p.category.name if p.category else '未分类' }}
                    </span>
            </td>
            <td>
                <!-- 标签展示 -->
                {% for t in p.tags %}
                <span style="background:#f1f3f4; color: #5f6368; padding:2px 6px; border-radius:4px; font-size:11px; margin-right:3px; border: 1px solid #e0e0e0;">
                            #{{ t.name }}
                        </span>
                {% else %}
                <span style="color: #ccc; font-size: 12px;">无标签</span>
                {% endfor %}
            </td>
            <td>
                <!-- 时间展示 -->
                <span style="color:#888; font-size:12px;">
                        {{ p.update_time.strftime('%Y-%m-%d %H:%M') if p.update_time else '未知' }}
                    </span>
            </td>
            <td>
                <a href="{{ url_for('view_article', article_id=p.id) }}" target="_blank"
                   style="color:#28a745; text-decoration:none; font-size:14px; font-weight: 500;">查看</a>
                <a href="{{ url_for('edit_article', article_id=p.id) }}"
                   style="color:#4285f4; margin-left:15px; text-decoration:none; font-size:14px; font-weight: 500;">编辑</a>
                <a href="{{ url_for('delete_article', article_id=p.id) }}"
                   style="color:#ea4335; margin-left:15px; text-decoration:none; font-size:14px; font-weight: 500;"
                   onclick="return confirm('确定要永久删除这篇文章吗？')">删除</a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="5" style="text-align:center; color:#999; padding:40px;">你的仓库还是空的，快去写第一篇文章吧！
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div id="cropper-modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:12px; max-width:90%; width:600px;">
        <h3 style="margin-top:0;">编辑图片</h3>
        <div style="max-height:400px; overflow:hidden; background:#eee;">
            <img id="cropper-image" style="max-width:100%;">
        </div>
        <div style="margin-top:20px; text-align:right; gap:10px; display:flex; justify-content:flex-end;">
            <button type="button" class="btn" style="background:#666;" onclick="closeCropper()">取消</button>
            <button type="button" class="btn" id="confirm-crop">确定裁剪并上传</button>
        </div>
    </div>
</div>


{% endblock %}